use serde_json::json;
use std::time::Instant;

fn main() {
    // == Jolt Execution (Loop 1 baseline) ==
    println!("<record>{}</record>", json!({"context":"Compiler","status":"start"}));
    let timer = Instant::now();

    let target_dir = "/tmp/jolt-guest-targets";
    let mut program = guest::compile_loop1(target_dir);

    println!(
        "<record>{}</record>",
        json!({"context":"Compiler","status":"success","time": format!("{:.2?}", timer.elapsed())})
    );

    println!("<record>{}</record>", json!({"context":"Preprocessing","status":"start"}));
    let timer = Instant::now();

    // API compatibility across curated snapshots (mirrors arguzz).
    {% if commit_or_branch in [
      "55b9830a3944dde55d33a55c42522b81dd49f87a",
      "42de0ca1f581dd212dda7ff44feee806556531d2",
      "85bf51da10efa9c679c35ffc1a8d45cc6cb1c788",
      "e9caa23565dbb13019afe61a2c95f51d1999e286",
    ] %}
    let prover_preprocessing = guest::preprocess_prover_loop1(&program);
    let verifier_preprocessing = guest::preprocess_verifier_loop1(&program);
    {% else %}
    let prover_preprocessing = guest::preprocess_prover_loop1(&mut program);
    let verifier_preprocessing = guest::verifier_preprocessing_from_prover_loop1(&prover_preprocessing);
    {% endif %}

    let prove_loop1 = guest::build_prover_loop1(program, prover_preprocessing);
    let verify_loop1 = guest::build_verifier_loop1(verifier_preprocessing);

    println!(
        "<record>{}</record>",
        json!({"context":"Preprocessing","status":"success","time": format!("{:.2?}", timer.elapsed())})
    );

    // Inputs (x0 is implicit)
    let initial_regs: [u32; {{ initial_regs.keys()|length - 1 }}] = [
        {% for reg_idx in initial_regs.keys() if reg_idx != 0 %}
        {{ initial_regs[reg_idx] }}u32,
        {% endfor %}
    ];

    println!("<record>{}</record>", json!({"context":"Prover","status":"start"}));
    let timer = Instant::now();

    {% if commit_or_branch in [
      "55b9830a3944dde55d33a55c42522b81dd49f87a",
      "42de0ca1f581dd212dda7ff44feee806556531d2",
      "20ac6eb526af383e7b597273990b5e4b783cc2a6",
      "70c77337426615b67191b301e9175e2bb093830d",
      "85bf51da10efa9c679c35ffc1a8d45cc6cb1c788",
      "e9caa23565dbb13019afe61a2c95f51d1999e286",
    ] %}
    let (output, proof) = prove_loop1(initial_regs);
    {% else %}
    let (output, proof, program_io) = prove_loop1(initial_regs);
    {% endif %}

    let outputs: Vec<u32> = output.to_vec();
    println!(
        "<record>{}</record>",
        json!({"context":"Prover","status":"success","time": format!("{:.2?}", timer.elapsed()),"output": outputs})
    );

    println!("<record>{}</record>", json!({"context":"Verifier","status":"start"}));
    let timer = Instant::now();

    if !verify_loop1(
        initial_regs,
        output,
        {% if commit_or_branch in [
          "57ea518d6d9872fb221bf6ac97df1456a5494cf2",
          "20ac6eb526af383e7b597273990b5e4b783cc2a6",
          "70c77337426615b67191b301e9175e2bb093830d",
          "55b9830a3944dde55d33a55c42522b81dd49f87a",
          "42de0ca1f581dd212dda7ff44feee806556531d2",
          "85bf51da10efa9c679c35ffc1a8d45cc6cb1c788",
          "e9caa23565dbb13019afe61a2c95f51d1999e286",
        ] %}
        proof,
        {% else %}
        program_io.panic,
        proof,
        {% endif %}
    ) {
        panic!("verifier failed");
    }

    println!(
        "<record>{}</record>",
        json!({"context":"Verifier","status":"success","time": format!("{:.2?}", timer.elapsed())})
    );
}
