use nexus_sdk::{
    compile::{cargo::CargoPackager, Compile, Compiler},
    stwo::seq::Stwo,
    ByGuestCompilation, Local, Prover, Verifiable, Viewable,
};
use serde_json::json;
use std::time::Instant;

const PACKAGE: &str = "nexus-guest";

fn main() {
    // == Nexus Execution (Loop 1 baseline) ==
    println!("<record>{}</record>", json!({"context":"Compiler","status":"start"}));
    let timer = Instant::now();

    let mut prover_compiler = Compiler::<CargoPackager>::new(PACKAGE);
    let prover: Stwo<Local> = Stwo::compile(&mut prover_compiler).expect("compile");
    let elf = prover.elf.clone();

    println!(
        "<record>{}</record>",
        json!({"context":"Compiler","status":"success","time": format!("{:.2?}", timer.elapsed())})
    );

    let initial_regs: [u32; {{ initial_regs.keys()|length - 1 }}] = [
        {% for reg_idx in initial_regs.keys() if reg_idx != 0 %}
        {{ initial_regs[reg_idx] }}u32,
        {% endfor %}
    ];

    println!("<record>{}</record>", json!({"context":"Prover","status":"start"}));
    let timer = Instant::now();

    let (view, proof) = prover
        .prove_with_input::<[u32; {{ initial_regs.keys()|length - 1 }}], [u32; {{ initial_regs.keys()|length - 1 }}]>(
            &initial_regs,
            &initial_regs,
        )
        .expect("prover failed");

    let output = view
        .public_output::<[u32; {{ output_word_count }}]>()
        .expect("output retrieval failed");

    let outputs: Vec<u32> = output.to_vec();
    println!(
        "<record>{}</record>",
        json!({"context":"Prover","status":"success","time": format!("{:.2?}", timer.elapsed()),"output": outputs})
    );

    // Exit code check (keep it explicit; some bugs manifest as non-success exit).
    let exit_code = view.exit_code().expect("failed to retrieve exit code");
    assert!(
        exit_code == nexus_sdk::KnownExitCodes::ExitSuccess as u32,
        "unexpected exit code"
    );

    println!("<record>{}</record>", json!({"context":"Verifier","status":"start"}));
    let timer = Instant::now();

    proof
        .verify_expected::<[u32; {{ initial_regs.keys()|length - 1 }}], [u32; {{ output_word_count }}]>(
            &initial_regs,
            nexus_sdk::KnownExitCodes::ExitSuccess as u32,
            &output,
            &elf,
            &[],
        )
        .expect("verifier failed");

    println!(
        "<record>{}</record>",
        json!({"context":"Verifier","status":"success","time": format!("{:.2?}", timer.elapsed())})
    );
}

