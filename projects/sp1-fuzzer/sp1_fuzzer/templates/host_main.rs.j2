use sp1_sdk::{ProverClient, SP1Stdin};
use serde_json::json;
use std::fs;
use std::time::Instant;

const SP1_GUEST_PATH: &str = "../target/riscv32im-succinct-zkvm-elf/release/sp1-guest";

fn create_sp1_stdin() -> SP1Stdin {
    let mut stdin = SP1Stdin::new();
    {% for reg_idx in initial_regs.keys() if reg_idx != 0 %}
    stdin.write(&{{ initial_regs[reg_idx] }}u32);
    {% endfor %}
    stdin
}

fn main() {
    sp1_sdk::utils::setup_logger();

    // == SP1 Execution (Loop 1 baseline) ==
    println!("<record>{}</record>", json!({"context":"Executor","status":"start"}));
    let timer = Instant::now();
    let client = ProverClient::builder().cpu().build();
    let stdin = create_sp1_stdin();
    let elf = fs::read(SP1_GUEST_PATH).expect("read guest elf");
    let (mut public_values, _report) = client.execute(&elf, stdin).run().unwrap();

    let mut outputs: Vec<u32> = Vec::new();
    for _ in 0..{{ output_word_count }} {
        outputs.push(public_values.read::<u32>());
    }

    println!(
        "<record>{}</record>",
        json!({"context":"Executor","status":"success","time": format!("{:.2?}", timer.elapsed()),"output": outputs})
    );
}
